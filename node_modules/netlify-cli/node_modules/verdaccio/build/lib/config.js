"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _assert = _interopRequireDefault(require("assert"));

var _lodash = _interopRequireDefault(require("lodash"));

var _authUtils = require("./auth-utils");

var _configUtils = require("./config-utils");

var _constants = require("./constants");

var _cryptoUtils = require("./crypto-utils");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const LoggerApi = require('./logger');

const strategicConfigProps = ['uplinks', 'packages'];
const allowedEnvConfig = ['http_proxy', 'https_proxy', 'no_proxy'];
/**
 * Coordinates the application configuration
 */

class Config {
  // @ts-ignore
  // @ts-ignore
  // @ts-ignore
  constructor(config) {
    const self = this;
    this.logger = LoggerApi.logger;
    this.self_path = config.self_path;
    this.storage = process.env.VERDACCIO_STORAGE_PATH || config.storage;
    this.plugins = config.plugins;

    for (const configProp in config) {
      if (self[configProp] == null) {
        self[configProp] = config[configProp];
      }
    }

    if (config !== null && config !== void 0 && config.user_agent) {
      this.user_agent = (0, _utils.getUserAgent)(config === null || config === void 0 ? void 0 : config.user_agent);
    }

    this.userRateLimit = _objectSpread(_objectSpread({}, _authUtils.defaultUserRateLimiting), config === null || config === void 0 ? void 0 : config.userRateLimit); // some weird shell scripts are valid yaml files parsed as string

    (0, _assert.default)(_lodash.default.isObject(config), _constants.APP_ERROR.CONFIG_NOT_VALID); // sanity check for strategic config properties

    strategicConfigProps.forEach(function (x) {
      if (self[x] == null) {
        self[x] = {};
      }

      (0, _assert.default)((0, _utils.isObject)(self[x]), `CONFIG: bad "${x}" value (object expected)`);
    });
    this.uplinks = (0, _configUtils.sanityCheckUplinksProps)((0, _configUtils.uplinkSanityCheck)(this.uplinks));

    if (_lodash.default.isNil(this.users) === false) {
      this.logger.warn(`[users]: property on configuration file
      is not longer supported, property being ignored`);
    }

    this.packages = (0, _configUtils.normalisePackageAccess)(self.packages); // loading these from ENV if aren't in config

    allowedEnvConfig.forEach(envConf => {
      if (!(envConf in self)) {
        self[envConf] = process.env[envConf] || process.env[envConf.toUpperCase()];
      }
    }); // unique identifier of self server (or a cluster), used to avoid loops
    // @ts-ignore

    if (!this.server_id) {
      this.server_id = (0, _cryptoUtils.generateRandomHexString)(6);
    }
  }
  /**
   * Check for package spec
   */


  getMatchedPackagesSpec(pkgName) {
    return (0, _configUtils.getMatchedPackagesSpec)(pkgName, this.packages);
  }
  /**
   * Store or create whether receive a secret key
   */


  checkSecretKey(secret) {
    if (_lodash.default.isString(secret) && _lodash.default.isEmpty(secret) === false) {
      this.secret = secret;
      return secret;
    } // it generates a secret key
    // FUTURE: this might be an external secret key, perhaps within config file?


    this.secret = (0, _cryptoUtils.generateRandomHexString)(32);
    return this.secret;
  }

}

var _default = Config;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvY29uZmlnLnRzIl0sIm5hbWVzIjpbIkxvZ2dlckFwaSIsInJlcXVpcmUiLCJzdHJhdGVnaWNDb25maWdQcm9wcyIsImFsbG93ZWRFbnZDb25maWciLCJDb25maWciLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsInNlbGYiLCJsb2dnZXIiLCJzZWxmX3BhdGgiLCJzdG9yYWdlIiwicHJvY2VzcyIsImVudiIsIlZFUkRBQ0NJT19TVE9SQUdFX1BBVEgiLCJwbHVnaW5zIiwiY29uZmlnUHJvcCIsInVzZXJfYWdlbnQiLCJ1c2VyUmF0ZUxpbWl0IiwiZGVmYXVsdFVzZXJSYXRlTGltaXRpbmciLCJfIiwiaXNPYmplY3QiLCJBUFBfRVJST1IiLCJDT05GSUdfTk9UX1ZBTElEIiwiZm9yRWFjaCIsIngiLCJ1cGxpbmtzIiwiaXNOaWwiLCJ1c2VycyIsIndhcm4iLCJwYWNrYWdlcyIsImVudkNvbmYiLCJ0b1VwcGVyQ2FzZSIsInNlcnZlcl9pZCIsImdldE1hdGNoZWRQYWNrYWdlc1NwZWMiLCJwa2dOYW1lIiwiY2hlY2tTZWNyZXRLZXkiLCJzZWNyZXQiLCJpc1N0cmluZyIsImlzRW1wdHkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFLQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7OztBQUVBLE1BQU1BLFNBQVMsR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBekI7O0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcsQ0FBQyxTQUFELEVBQVksVUFBWixDQUE3QjtBQUNBLE1BQU1DLGdCQUFnQixHQUFHLENBQUMsWUFBRCxFQUFlLGFBQWYsRUFBOEIsVUFBOUIsQ0FBekI7QUFFQTtBQUNBO0FBQ0E7O0FBQ0EsTUFBTUMsTUFBTixDQUFrQztBQUVoQztBQUVBO0FBVUE7QUFHT0MsRUFBQUEsV0FBVyxDQUFDQyxNQUFELEVBQXdCO0FBQ3hDLFVBQU1DLElBQUksR0FBRyxJQUFiO0FBQ0EsU0FBS0MsTUFBTCxHQUFjUixTQUFT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Q0FBd0IsRUFBeEIsQ0FBZDtBQUNBLFdBQU8sS0FBS0EsTUFBWjtBQUNEOztBQTFGK0I7O2VBNkZuQmhDLE0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyBDb25maWcgYXMgQXBwQ29uZmlnLCBMb2dnZXIsIFBhY2thZ2VMaXN0LCBSYXRlTGltaXQsIFNlY3VyaXR5IH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5cbmltcG9ydCB7IE1hdGNoZWRQYWNrYWdlLCBTdGFydFVwQ29uZmlnIH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuaW1wb3J0IHsgZGVmYXVsdFVzZXJSYXRlTGltaXRpbmcgfSBmcm9tICcuL2F1dGgtdXRpbHMnO1xuaW1wb3J0IHsgZ2V0TWF0Y2hlZFBhY2thZ2VzU3BlYywgbm9ybWFsaXNlUGFja2FnZUFjY2Vzcywgc2FuaXR5Q2hlY2tVcGxpbmtzUHJvcHMsIHVwbGlua1Nhbml0eUNoZWNrIH0gZnJvbSAnLi9jb25maWctdXRpbHMnO1xuaW1wb3J0IHsgQVBQX0VSUk9SIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgZ2VuZXJhdGVSYW5kb21IZXhTdHJpbmcgfSBmcm9tICcuL2NyeXB0by11dGlscyc7XG5pbXBvcnQgeyBnZXRVc2VyQWdlbnQsIGlzT2JqZWN0IH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IExvZ2dlckFwaSA9IHJlcXVpcmUoJy4vbG9nZ2VyJyk7XG5jb25zdCBzdHJhdGVnaWNDb25maWdQcm9wcyA9IFsndXBsaW5rcycsICdwYWNrYWdlcyddO1xuY29uc3QgYWxsb3dlZEVudkNvbmZpZyA9IFsnaHR0cF9wcm94eScsICdodHRwc19wcm94eScsICdub19wcm94eSddO1xuXG4vKipcbiAqIENvb3JkaW5hdGVzIHRoZSBhcHBsaWNhdGlvbiBjb25maWd1cmF0aW9uXG4gKi9cbmNsYXNzIENvbmZpZyBpbXBsZW1lbnRzIEFwcENvbmZpZyB7XG4gIHB1YmxpYyBsb2dnZXI6IExvZ2dlcjtcbiAgLy8gQHRzLWlnbm9yZVxuICBwdWJsaWMgdXNlcl9hZ2VudDogYm9vbGVhbiB8IHN0cmluZztcbiAgLy8gQHRzLWlnbm9yZVxuICBwdWJsaWMgc2VjcmV0OiBzdHJpbmc7XG4gIHB1YmxpYyB1cGxpbmtzOiBhbnk7XG4gIHB1YmxpYyBwYWNrYWdlczogUGFja2FnZUxpc3Q7XG4gIHB1YmxpYyB1c2VyczogYW55O1xuICBwdWJsaWMgdXNlclJhdGVMaW1pdDogUmF0ZUxpbWl0O1xuICBwdWJsaWMgc2VydmVyX2lkOiBzdHJpbmc7XG4gIHB1YmxpYyBzZWxmX3BhdGg6IHN0cmluZztcbiAgcHVibGljIHN0b3JhZ2U6IHN0cmluZyB8IHZvaWQ7XG4gIHB1YmxpYyBwbHVnaW5zOiBzdHJpbmcgfCB2b2lkO1xuICAvLyBAdHMtaWdub3JlXG4gIHB1YmxpYyBzZWN1cml0eTogU2VjdXJpdHk7XG5cbiAgcHVibGljIGNvbnN0cnVjdG9yKGNvbmZpZzogU3RhcnRVcENvbmZpZykge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIHRoaXMubG9nZ2VyID0gTG9nZ2VyQXBpLmxvZ2dlcjtcbiAgICB0aGlzLnNlbGZfcGF0aCA9IGNvbmZpZy5zZWxmX3BhdGg7XG4gICAgdGhpcy5zdG9yYWdlID0gcHJvY2Vzcy5lbnYuVkVSREFDQ0lPX1NUT1JBR0VfUEFUSCB8fCBjb25maWcuc3RvcmFnZTtcbiAgICB0aGlzLnBsdWdpbnMgPSBjb25maWcucGx1Z2lucztcblxuICAgIGZvciAoY29uc3QgY29uZmlnUHJvcCBpbiBjb25maWcpIHtcbiAgICAgIGlmIChzZWxmW2NvbmZpZ1Byb3BdID09IG51bGwpIHtcbiAgICAgICAgc2VsZltjb25maWdQcm9wXSA9IGNvbmZpZ1tjb25maWdQcm9wXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY29uZmlnPy51c2VyX2FnZW50KSB7XG4gICAgICB0aGlzLnVzZXJfYWdlbnQgPSBnZXRVc2VyQWdlbnQoY29uZmlnPy51c2VyX2FnZW50KTtcbiAgICB9XG5cbiAgICB0aGlzLnVzZXJSYXRlTGltaXQgPSB7IC4uLmRlZmF1bHRVc2VyUmF0ZUxpbWl0aW5nLCAuLi5jb25maWc/LnVzZXJSYXRlTGltaXQgfTtcblxuICAgIC8vIHNvbWUgd2VpcmQgc2hlbGwgc2NyaXB0cyBhcmUgdmFsaWQgeWFtbCBmaWxlcyBwYXJzZWQgYXMgc3RyaW5nXG4gICAgYXNzZXJ0KF8uaXNPYmplY3QoY29uZmlnKSwgQVBQX0VSUk9SLkNPTkZJR19OT1RfVkFMSUQpO1xuXG4gICAgLy8gc2FuaXR5IGNoZWNrIGZvciBzdHJhdGVnaWMgY29uZmlnIHByb3BlcnRpZXNcbiAgICBzdHJhdGVnaWNDb25maWdQcm9wcy5mb3JFYWNoKGZ1bmN0aW9uICh4KTogdm9pZCB7XG4gICAgICBpZiAoc2VsZlt4XSA9PSBudWxsKSB7XG4gICAgICAgIHNlbGZbeF0gPSB7fTtcbiAgICAgIH1cblxuICAgICAgYXNzZXJ0KGlzT2JqZWN0KHNlbGZbeF0pLCBgQ09ORklHOiBiYWQgXCIke3h9XCIgdmFsdWUgKG9iamVjdCBleHBlY3RlZClgKTtcbiAgICB9KTtcblxuICAgIHRoaXMudXBsaW5rcyA9IHNhbml0eUNoZWNrVXBsaW5rc1Byb3BzKHVwbGlua1Nhbml0eUNoZWNrKHRoaXMudXBsaW5rcykpO1xuXG4gICAgaWYgKF8uaXNOaWwodGhpcy51c2VycykgPT09IGZhbHNlKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKGBbdXNlcnNdOiBwcm9wZXJ0eSBvbiBjb25maWd1cmF0aW9uIGZpbGVcbiAgICAgIGlzIG5vdCBsb25nZXIgc3VwcG9ydGVkLCBwcm9wZXJ0eSBiZWluZyBpZ25vcmVkYCk7XG4gICAgfVxuXG4gICAgdGhpcy5wYWNrYWdlcyA9IG5vcm1hbGlzZVBhY2thZ2VBY2Nlc3Moc2VsZi5wYWNrYWdlcyk7XG5cbiAgICAvLyBsb2FkaW5nIHRoZXNlIGZyb20gRU5WIGlmIGFyZW4ndCBpbiBjb25maWdcbiAgICBhbGxvd2VkRW52Q29uZmlnLmZvckVhY2goKGVudkNvbmYpOiB2b2lkID0+IHtcbiAgICAgIGlmICghKGVudkNvbmYgaW4gc2VsZikpIHtcbiAgICAgICAgc2VsZltlbnZDb25mXSA9IHByb2Nlc3MuZW52W2VudkNvbmZdIHx8IHByb2Nlc3MuZW52W2VudkNvbmYudG9VcHBlckNhc2UoKV07XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyB1bmlxdWUgaWRlbnRpZmllciBvZiBzZWxmIHNlcnZlciAob3IgYSBjbHVzdGVyKSwgdXNlZCB0byBhdm9pZCBsb29wc1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBpZiAoIXRoaXMuc2VydmVyX2lkKSB7XG4gICAgICB0aGlzLnNlcnZlcl9pZCA9IGdlbmVyYXRlUmFuZG9tSGV4U3RyaW5nKDYpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBmb3IgcGFja2FnZSBzcGVjXG4gICAqL1xuICBwdWJsaWMgZ2V0TWF0Y2hlZFBhY2thZ2VzU3BlYyhwa2dOYW1lOiBzdHJpbmcpOiBNYXRjaGVkUGFja2FnZSB7XG4gICAgcmV0dXJuIGdldE1hdGNoZWRQYWNrYWdlc1NwZWMocGtnTmFtZSwgdGhpcy5wYWNrYWdlcyk7XG4gIH1cblxuICAvKipcbiAgICogU3RvcmUgb3IgY3JlYXRlIHdoZXRoZXIgcmVjZWl2ZSBhIHNlY3JldCBrZXlcbiAgICovXG4gIHB1YmxpYyBjaGVja1NlY3JldEtleShzZWNyZXQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKF8uaXNTdHJpbmcoc2VjcmV0KSAmJiBfLmlzRW1wdHkoc2VjcmV0KSA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuc2VjcmV0ID0gc2VjcmV0O1xuICAgICAgcmV0dXJuIHNlY3JldDtcbiAgICB9XG4gICAgLy8gaXQgZ2VuZXJhdGVzIGEgc2VjcmV0IGtleVxuICAgIC8vIEZVVFVSRTogdGhpcyBtaWdodCBiZSBhbiBleHRlcm5hbCBzZWNyZXQga2V5LCBwZXJoYXBzIHdpdGhpbiBjb25maWcgZmlsZT9cbiAgICB0aGlzLnNlY3JldCA9IGdlbmVyYXRlUmFuZG9tSGV4U3RyaW5nKDMyKTtcbiAgICByZXR1cm4gdGhpcy5zZWNyZXQ7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ29uZmlnO1xuIl19