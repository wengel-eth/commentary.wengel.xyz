"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createLogger = createLogger;
exports.getLogger = getLogger;
exports.logger = void 0;
exports.setup = setup;

var _debug = _interopRequireDefault(require("debug"));

var _lodash = _interopRequireDefault(require("lodash"));

var _pino = _interopRequireDefault(require("pino"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function isProd() {
  return process.env.NODE_ENV === 'production';
}

let logger;
exports.logger = logger;
const debug = (0, _debug.default)('verdaccio:logger');
const DEFAULT_LOG_FORMAT = isProd() ? 'json' : 'pretty';

function createLogger(options = {
  level: 'http'
}, destination = _pino.default.destination(1), format = DEFAULT_LOG_FORMAT, prettyPrintOptions) {
  if (_lodash.default.isNil(format)) {
    format = DEFAULT_LOG_FORMAT;
  }

  let pinoConfig = _objectSpread(_objectSpread({
    customLevels: {
      http: 25
    }
  }, options), {}, {
    level: options.level,
    serializers: {
      err: _pino.default.stdSerializers.err,
      req: _pino.default.stdSerializers.req,
      res: _pino.default.stdSerializers.res
    }
  });

  debug('has prettifier? %o', !isProd()); // pretty logs are not allowed in production for performance reasons

  if ((format === DEFAULT_LOG_FORMAT || format !== 'json') && isProd() === false) {
    pinoConfig = Object.assign({}, pinoConfig, {
      // more info
      // https://github.com/pinojs/pino-pretty/issues/37
      prettyPrint: _objectSpread({
        levelFirst: true,
        prettyStamp: format === 'pretty-timestamped'
      }, prettyPrintOptions),
      prettifier: require('./formatter')
    });
  }

  const logger = (0, _pino.default)(pinoConfig, destination);

  if (process.env.DEBUG) {
    logger.on('level-change', (lvl, val, prevLvl, prevVal) => {
      debug('%s (%d) was changed to %s (%d)', lvl, val, prevLvl, prevVal);
    });
  }

  return logger;
}

function getLogger() {
  if (_lodash.default.isNil(logger)) {
    process.emitWarning('logger is not defined');
    return;
  }

  return logger;
}

const DEFAULT_LOGGER_CONF = {
  type: 'stdout',
  format: 'pretty',
  level: 'http',
  colors: true
};

function setup(options = [DEFAULT_LOGGER_CONF]) {
  var _loggerConfig, _loggerConfig2, _loggerConfig3;

  debug('setup logger');
  const isLegacyConf = Array.isArray(options);

  if (isLegacyConf) {
    const deprecateMessage = 'deprecate: multiple logger configuration is deprecated, please check the migration guide.';
    process.emitWarning(deprecateMessage);
  } // verdaccio 5 does not allow multiple logger configuration
  // backward compatible, pick only the first option
  // next major will thrown an error


  let loggerConfig = isLegacyConf ? options[0] : options;

  if (!((_loggerConfig = loggerConfig) !== null && _loggerConfig !== void 0 && _loggerConfig.level)) {
    loggerConfig = Object.assign({}, {
      level: 'http'
    }, loggerConfig);
  }

  const pinoConfig = {
    level: loggerConfig.level
  };
  let colors = typeof ((_loggerConfig2 = loggerConfig) === null || _loggerConfig2 === void 0 ? void 0 : _loggerConfig2.colors) === 'boolean' ? Boolean((_loggerConfig3 = loggerConfig) === null || _loggerConfig3 === void 0 ? void 0 : _loggerConfig3.colors) : process.stdout.isTTY;

  if ('EXPERIMENTAL_VERDACCIO_LOGGER_COLORS' in process.env) {
    colors = process.env.EXPERIMENTAL_VERDACCIO_LOGGER_COLORS != 'false';
  }

  const prettyPrintOptions = {
    // we hide warning since the prettifier should not be used in production
    // https://getpino.io/#/docs/pretty?id=prettifier-api
    suppressFlushSyncWarning: true,
    colors
  };

  if (loggerConfig.type === 'file') {
    debug('logging file enabled');

    const destination = _pino.default.destination(loggerConfig.path);

    process.on('SIGUSR2', () => destination.reopen());
    exports.logger = logger = createLogger(pinoConfig, destination, loggerConfig.format, prettyPrintOptions);
  } else if (loggerConfig.type === 'rotating-file') {
    process.emitWarning('rotating-file type is not longer supported, consider use [logrotate] instead');
    debug('logging stdout enabled');
    exports.logger = logger = createLogger(pinoConfig, _pino.default.destination(1), loggerConfig.format, prettyPrintOptions);
  } else {
    debug('logging stdout enabled');
    exports.logger = logger = createLogger(pinoConfig, _pino.default.destination(1), loggerConfig.format, prettyPrintOptions);
  }

  if (isProd()) {
    // why only on prod? https://github.com/pinojs/pino/issues/920#issuecomment-710807667
    const finalHandler = _pino.default.final(logger, (err, finalLogger, event) => {
      finalLogger.info(`${event} caught`);

      if (err) {
        finalLogger.error(err, 'error caused exit');
      }

      process.exit(err ? 1 : 0);
    });

    process.on('uncaughtException', err => finalHandler(err, 'uncaughtException'));
    process.on('unhandledRejection', err => finalHandler(err, 'unhandledRejection'));
    process.on('beforeExit', () => finalHandler(null, 'beforeExit'));
    process.on('exit', () => finalHandler(null, 'exit'));
    process.on('uncaughtException', err => finalHandler(err, 'uncaughtException'));
    process.on('SIGINT', () => finalHandler(null, 'SIGINT'));
    process.on('SIGQUIT', () => finalHandler(null, 'SIGQUIT'));
    process.on('SIGTERM', () => finalHandler(null, 'SIGTERM'));
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvbG9nZ2VyL2xvZ2dlci50cyJdLCJuYW1lcyI6WyJpc1Byb2QiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJsb2dnZXIiLCJkZWJ1ZyIsIkRFRkFVTFRfTE9HX0ZPUk1BVCIsImNyZWF0ZUxvZ2dlciIsIm9wdGlvbnMiLCJsZXZlbCIsImRlc3RpbmF0aW9uIiwicGlubyIsImZvcm1hdCIsInByZXR0eVByaW50T3B0aW9ucyIsIl8iLCJpc05pbCIsInBpbm9Db25maWciLCJjdXN0b21MZXZlbHMiLCJodHRwIiwic2VyaWFsaXplcnMiLCJlcnIiLCJzdGRTZXJpYWxpemVycyIsInJlcSIsInJlcyIsIk9iamVjdCIsImFzc2lnbiIsInByZXR0eVByaW50IiwibGV2ZWxGaXJzdCIsInByZXR0eVN0YW1wIiwicHJldHRpZmllciIsInJlcXVpcmUiLCJERUJVRyIsIm9uIiwibHZsIiwidmFsIiwicHJldkx2bCIsInByZXZWYWwiLCJnZXRMb2dnZXIiLCJlbWl0V2FybmluZyIsIkRFRkFVTFRfTE9HR0VSX0NPTkYiLCJ0eXBlIiwiY29sb3JzIiwic2V0dXAiLCJpc0xlZ2FjeUNvbmYiLCJBcnJheSIsImlzQXJyYXkiLCJkZXByZWNhdGVNZXNzYWdlIiwibG9nZ2VyQ29uZmlnIiwiQm9vbGVhbiIsInN0ZG91dCIsImlzVFRZIiwiRVhQRVJJTUVOVEFMX1ZFUkRBQ0NJT19MT0dHRVJfQ09MT1JTIiwic3VwcHJlc3NGbHVzaFN5bmNXYXJuaW5nIiwicGF0aCIsInJlb3BlbiIsImZpbmFsSGFuZGxlciIsImZpbmFsIiwiZmluYWxMb2dnZXIiLCJldmVudCIsImluZm8iLCJlcnJvciIsImV4aXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQTs7QUFFQTs7QUFDQTs7Ozs7Ozs7OztBQUVBLFNBQVNBLE1BQVQsR0FBa0I7QUFDaEIsU0FBT0MsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFFBQVosS0FBeUIsWUFBaEM7QUFDRDs7QUFFTSxJ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QjtBQUNEOztBQUNEbkIsTUFBQUEsT0FBTyxDQUFDNEQsSUFBUixDQUFhekMsR0FBRyxHQUFHLENBQUgsR0FBTyxDQUF2QjtBQUNELEtBTm9CLENBQXJCOztBQVFBbkIsSUFBQUEsT0FBTyxDQUFDK0IsRUFBUixDQUFXLG1CQUFYLEVBQWlDWixHQUFELElBQVNtQyxZQUFZLENBQUNuQyxHQUFELEVBQU0sbUJBQU4sQ0FBckQ7QUFDQW5CLElBQUFBLE9BQU8sQ0FBQytCLEVBQVIsQ0FBVyxvQkFBWCxFQUFrQ1osR0FBRCxJQUFTbUMsWUFBWSxDQUFDbkMsR0FBRCxFQUFlLG9CQUFmLENBQXREO0FBQ0FuQixJQUFBQSxPQUFPLENBQUMrQixFQUFSLENBQVcsWUFBWCxFQUF5QixNQUFNdUIsWUFBWSxDQUFDLElBQUQsRUFBTyxZQUFQLENBQTNDO0FBQ0F0RCxJQUFBQSxPQUFPLENBQUMrQixFQUFSLENBQVcsTUFBWCxFQUFtQixNQUFNdUIsWUFBWSxDQUFDLElBQUQsRUFBTyxNQUFQLENBQXJDO0FBQ0F0RCxJQUFBQSxPQUFPLENBQUMrQixFQUFSLENBQVcsbUJBQVgsRUFBaUNaLEdBQUQsSUFBU21DLFlBQVksQ0FBQ25DLEdBQUQsRUFBTSxtQkFBTixDQUFyRDtBQUNBbkIsSUFBQUEsT0FBTyxDQUFDK0IsRUFBUixDQUFXLFFBQVgsRUFBcUIsTUFBTXVCLFlBQVksQ0FBQyxJQUFELEVBQU8sUUFBUCxDQUF2QztBQUNBdEQsSUFBQUEsT0FBTyxDQUFDK0IsRUFBUixDQUFXLFNBQVgsRUFBc0IsTUFBTXVCLFlBQVksQ0FBQyxJQUFELEVBQU8sU0FBUCxDQUF4QztBQUNBdEQsSUFBQUEsT0FBTyxDQUFDK0IsRUFBUixDQUFXLFNBQVgsRUFBc0IsTUFBTXVCLFlBQVksQ0FBQyxJQUFELEVBQU8sU0FBUCxDQUF4QztBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYnVpbGREZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgeyB5ZWxsb3cgfSBmcm9tICdrbGV1cic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBpbm8gZnJvbSAncGlubyc7XG5cbmZ1bmN0aW9uIGlzUHJvZCgpIHtcbiAgcmV0dXJuIHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbic7XG59XG5cbmV4cG9ydCBsZXQgbG9nZ2VyO1xuY29uc3QgZGVidWcgPSBidWlsZERlYnVnKCd2ZXJkYWNjaW86bG9nZ2VyJyk7XG5jb25zdCBERUZBVUxUX0xPR19GT1JNQVQgPSBpc1Byb2QoKSA/ICdqc29uJyA6ICdwcmV0dHknO1xuXG5leHBvcnQgdHlwZSBMb2dQbHVnaW4gPSB7XG4gIGRlc3Q6IHN0cmluZztcbiAgb3B0aW9ucz86IGFueVtdO1xufTtcblxuZXhwb3J0IHR5cGUgTG9nVHlwZSA9ICdmaWxlJyB8ICdzdGRvdXQnO1xuZXhwb3J0IHR5cGUgTG9nRm9ybWF0ID0gJ2pzb24nIHwgJ3ByZXR0eS10aW1lc3RhbXBlZCcgfCAncHJldHR5JztcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUxvZ2dlcihvcHRpb25zID0geyBsZXZlbDogJ2h0dHAnIH0sIGRlc3RpbmF0aW9uID0gcGluby5kZXN0aW5hdGlvbigxKSwgZm9ybWF0OiBMb2dGb3JtYXQgPSBERUZBVUxUX0xPR19GT1JNQVQsIHByZXR0eVByaW50T3B0aW9ucykge1xuICBpZiAoXy5pc05pbChmb3JtYXQpKSB7XG4gICAgZm9ybWF0ID0gREVGQVVMVF9MT0dfRk9STUFUO1xuICB9XG5cbiAgbGV0IHBpbm9Db25maWcgPSB7XG4gICAgY3VzdG9tTGV2ZWxzOiB7XG4gICAgICBodHRwOiAyNSxcbiAgICB9LFxuICAgIC4uLm9wdGlvbnMsXG4gICAgbGV2ZWw6IG9wdGlvbnMubGV2ZWwsXG4gICAgc2VyaWFsaXplcnM6IHtcbiAgICAgIGVycjogcGluby5zdGRTZXJpYWxpemVycy5lcnIsXG4gICAgICByZXE6IHBpbm8uc3RkU2VyaWFsaXplcnMucmVxLFxuICAgICAgcmVzOiBwaW5vLnN0ZFNlcmlhbGl6ZXJzLnJlcyxcbiAgICB9LFxuICB9O1xuXG4gIGRlYnVnKCdoYXMgcHJldHRpZmllcj8gJW8nLCAhaXNQcm9kKCkpO1xuICAvLyBwcmV0dHkgbG9ncyBhcmUgbm90IGFsbG93ZWQgaW4gcHJvZHVjdGlvbiBmb3IgcGVyZm9ybWFuY2UgcmVhc29uc1xuICBpZiAoKGZvcm1hdCA9PT0gREVGQVVMVF9MT0dfRk9STUFUIHx8IGZvcm1hdCAhPT0gJ2pzb24nKSAmJiBpc1Byb2QoKSA9PT0gZmFsc2UpIHtcbiAgICBwaW5vQ29uZmlnID0gT2JqZWN0LmFzc2lnbih7fSwgcGlub0NvbmZpZywge1xuICAgICAgLy8gbW9yZSBpbmZvXG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vcGlub2pzL3Bpbm8tcHJldHR5L2lzc3Vlcy8zN1xuICAgICAgcHJldHR5UHJpbnQ6IHtcbiAgICAgICAgbGV2ZWxGaXJzdDogdHJ1ZSxcbiAgICAgICAgcHJldHR5U3RhbXA6IGZvcm1hdCA9PT0gJ3ByZXR0eS10aW1lc3RhbXBlZCcsXG4gICAgICAgIC4uLnByZXR0eVByaW50T3B0aW9ucyxcbiAgICAgIH0sXG4gICAgICBwcmV0dGlmaWVyOiByZXF1aXJlKCcuL2Zvcm1hdHRlcicpLFxuICAgIH0pO1xuICB9XG4gIGNvbnN0IGxvZ2dlciA9IHBpbm8ocGlub0NvbmZpZywgZGVzdGluYXRpb24pO1xuXG4gIGlmIChwcm9jZXNzLmVudi5ERUJVRykge1xuICAgIGxvZ2dlci5vbignbGV2ZWwtY2hhbmdlJywgKGx2bCwgdmFsLCBwcmV2THZsLCBwcmV2VmFsKSA9PiB7XG4gICAgICBkZWJ1ZygnJXMgKCVkKSB3YXMgY2hhbmdlZCB0byAlcyAoJWQpJywgbHZsLCB2YWwsIHByZXZMdmwsIHByZXZWYWwpO1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGxvZ2dlcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldExvZ2dlcigpIHtcbiAgaWYgKF8uaXNOaWwobG9nZ2VyKSkge1xuICAgIHByb2Nlc3MuZW1pdFdhcm5pbmcoJ2xvZ2dlciBpcyBub3QgZGVmaW5lZCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHJldHVybiBsb2dnZXI7XG59XG5cbmNvbnN0IERFRkFVTFRfTE9HR0VSX0NPTkY6IExvZ2dlckNvbmZpZ0l0ZW0gPSB7XG4gIHR5cGU6ICdzdGRvdXQnLFxuICBmb3JtYXQ6ICdwcmV0dHknLFxuICBsZXZlbDogJ2h0dHAnLFxuICBjb2xvcnM6IHRydWUsXG59O1xuXG5leHBvcnQgdHlwZSBMb2dnZXJDb25maWdJdGVtID0ge1xuICB0eXBlPzogTG9nVHlwZTtcbiAgcGx1Z2luPzogTG9nUGx1Z2luO1xuICBmb3JtYXQ/OiBMb2dGb3JtYXQ7XG4gIHBhdGg/OiBzdHJpbmc7XG4gIGxldmVsPzogc3RyaW5nO1xuICBjb2xvcnM/OiBib29sZWFuO1xufTtcblxuZXhwb3J0IHR5cGUgTG9nZ2VyQ29uZmlnID0gTG9nZ2VyQ29uZmlnSXRlbVtdO1xuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXAob3B0aW9uczogTG9nZ2VyQ29uZmlnIHwgTG9nZ2VyQ29uZmlnSXRlbSA9IFtERUZBVUxUX0xPR0dFUl9DT05GXSkge1xuICBkZWJ1Zygnc2V0dXAgbG9nZ2VyJyk7XG4gIGNvbnN0IGlzTGVnYWN5Q29uZiA9IEFycmF5LmlzQXJyYXkob3B0aW9ucyk7XG4gIGlmIChpc0xlZ2FjeUNvbmYpIHtcbiAgICBjb25zdCBkZXByZWNhdGVNZXNzYWdlID0gJ2RlcHJlY2F0ZTogbXVsdGlwbGUgbG9nZ2VyIGNvbmZpZ3VyYXRpb24gaXMgZGVwcmVjYXRlZCwgcGxlYXNlIGNoZWNrIHRoZSBtaWdyYXRpb24gZ3VpZGUuJztcbiAgICBwcm9jZXNzLmVtaXRXYXJuaW5nKGRlcHJlY2F0ZU1lc3NhZ2UpO1xuICB9XG5cbiAgLy8gdmVyZGFjY2lvIDUgZG9lcyBub3QgYWxsb3cgbXVsdGlwbGUgbG9nZ2VyIGNvbmZpZ3VyYXRpb25cbiAgLy8gYmFja3dhcmQgY29tcGF0aWJsZSwgcGljayBvbmx5IHRoZSBmaXJzdCBvcHRpb25cbiAgLy8gbmV4dCBtYWpvciB3aWxsIHRocm93biBhbiBlcnJvclxuICBsZXQgbG9nZ2VyQ29uZmlnID0gaXNMZWdhY3lDb25mID8gb3B0aW9uc1swXSA6IG9wdGlvbnM7XG4gIGlmICghbG9nZ2VyQ29uZmlnPy5sZXZlbCkge1xuICAgIGxvZ2dlckNvbmZpZyA9IE9iamVjdC5hc3NpZ24oXG4gICAgICB7fSxcbiAgICAgIHtcbiAgICAgICAgbGV2ZWw6ICdodHRwJyxcbiAgICAgIH0sXG4gICAgICBsb2dnZXJDb25maWdcbiAgICApO1xuICB9XG4gIGNvbnN0IHBpbm9Db25maWcgPSB7IGxldmVsOiBsb2dnZXJDb25maWcubGV2ZWwgfTtcbiAgbGV0IGNvbG9ycyA9IHR5cGVvZiBsb2dnZXJDb25maWc/LmNvbG9ycyA9PT0gJ2Jvb2xlYW4nID8gQm9vbGVhbihsb2dnZXJDb25maWc/LmNvbG9ycykgOiBwcm9jZXNzLnN0ZG91dC5pc1RUWTtcbiAgaWYgKCdFWFBFUklNRU5UQUxfVkVSREFDQ0lPX0xPR0dFUl9DT0xPUlMnIGluIHByb2Nlc3MuZW52KSB7XG4gICAgY29sb3JzID0gcHJvY2Vzcy5lbnYuRVhQRVJJTUVOVEFMX1ZFUkRBQ0NJT19MT0dHRVJfQ09MT1JTICE9ICdmYWxzZSc7XG4gIH1cbiAgY29uc3QgcHJldHR5UHJpbnRPcHRpb25zID0ge1xuICAgIC8vIHdlIGhpZGUgd2FybmluZyBzaW5jZSB0aGUgcHJldHRpZmllciBzaG91bGQgbm90IGJlIHVzZWQgaW4gcHJvZHVjdGlvblxuICAgIC8vIGh0dHBzOi8vZ2V0cGluby5pby8jL2RvY3MvcHJldHR5P2lkPXByZXR0aWZpZXItYXBpXG4gICAgc3VwcHJlc3NGbHVzaFN5bmNXYXJuaW5nOiB0cnVlLFxuICAgIGNvbG9ycyxcbiAgfTtcbiAgaWYgKGxvZ2dlckNvbmZpZy50eXBlID09PSAnZmlsZScpIHtcbiAgICBkZWJ1ZygnbG9nZ2luZyBmaWxlIGVuYWJsZWQnKTtcbiAgICBjb25zdCBkZXN0aW5hdGlvbiA9IHBpbm8uZGVzdGluYXRpb24obG9nZ2VyQ29uZmlnLnBhdGgpO1xuICAgIHByb2Nlc3Mub24oJ1NJR1VTUjInLCAoKSA9PiBkZXN0aW5hdGlvbi5yZW9wZW4oKSk7XG4gICAgbG9nZ2VyID0gY3JlYXRlTG9nZ2VyKHBpbm9Db25maWcsIGRlc3RpbmF0aW9uLCBsb2dnZXJDb25maWcuZm9ybWF0LCBwcmV0dHlQcmludE9wdGlvbnMpO1xuICB9IGVsc2UgaWYgKGxvZ2dlckNvbmZpZy50eXBlID09PSAncm90YXRpbmctZmlsZScpIHtcbiAgICBwcm9jZXNzLmVtaXRXYXJuaW5nKCdyb3RhdGluZy1maWxlIHR5cGUgaXMgbm90IGxvbmdlciBzdXBwb3J0ZWQsIGNvbnNpZGVyIHVzZSBbbG9ncm90YXRlXSBpbnN0ZWFkJyk7XG4gICAgZGVidWcoJ2xvZ2dpbmcgc3Rkb3V0IGVuYWJsZWQnKTtcbiAgICBsb2dnZXIgPSBjcmVhdGVMb2dnZXIocGlub0NvbmZpZywgcGluby5kZXN0aW5hdGlvbigxKSwgbG9nZ2VyQ29uZmlnLmZvcm1hdCwgcHJldHR5UHJpbnRPcHRpb25zKTtcbiAgfSBlbHNlIHtcbiAgICBkZWJ1ZygnbG9nZ2luZyBzdGRvdXQgZW5hYmxlZCcpO1xuICAgIGxvZ2dlciA9IGNyZWF0ZUxvZ2dlcihwaW5vQ29uZmlnLCBwaW5vLmRlc3RpbmF0aW9uKDEpLCBsb2dnZXJDb25maWcuZm9ybWF0LCBwcmV0dHlQcmludE9wdGlvbnMpO1xuICB9XG5cbiAgaWYgKGlzUHJvZCgpKSB7XG4gICAgLy8gd2h5IG9ubHkgb24gcHJvZD8gaHR0cHM6Ly9naXRodWIuY29tL3Bpbm9qcy9waW5vL2lzc3Vlcy85MjAjaXNzdWVjb21tZW50LTcxMDgwNzY2N1xuICAgIGNvbnN0IGZpbmFsSGFuZGxlciA9IHBpbm8uZmluYWwobG9nZ2VyLCAoZXJyLCBmaW5hbExvZ2dlciwgZXZlbnQpID0+IHtcbiAgICAgIGZpbmFsTG9nZ2VyLmluZm8oYCR7ZXZlbnR9IGNhdWdodGApO1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBmaW5hbExvZ2dlci5lcnJvcihlcnIsICdlcnJvciBjYXVzZWQgZXhpdCcpO1xuICAgICAgfVxuICAgICAgcHJvY2Vzcy5leGl0KGVyciA/IDEgOiAwKTtcbiAgICB9KTtcblxuICAgIHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgKGVycikgPT4gZmluYWxIYW5kbGVyKGVyciwgJ3VuY2F1Z2h0RXhjZXB0aW9uJykpO1xuICAgIHByb2Nlc3Mub24oJ3VuaGFuZGxlZFJlamVjdGlvbicsIChlcnIpID0+IGZpbmFsSGFuZGxlcihlcnIgYXMgRXJyb3IsICd1bmhhbmRsZWRSZWplY3Rpb24nKSk7XG4gICAgcHJvY2Vzcy5vbignYmVmb3JlRXhpdCcsICgpID0+IGZpbmFsSGFuZGxlcihudWxsLCAnYmVmb3JlRXhpdCcpKTtcbiAgICBwcm9jZXNzLm9uKCdleGl0JywgKCkgPT4gZmluYWxIYW5kbGVyKG51bGwsICdleGl0JykpO1xuICAgIHByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgKGVycikgPT4gZmluYWxIYW5kbGVyKGVyciwgJ3VuY2F1Z2h0RXhjZXB0aW9uJykpO1xuICAgIHByb2Nlc3Mub24oJ1NJR0lOVCcsICgpID0+IGZpbmFsSGFuZGxlcihudWxsLCAnU0lHSU5UJykpO1xuICAgIHByb2Nlc3Mub24oJ1NJR1FVSVQnLCAoKSA9PiBmaW5hbEhhbmRsZXIobnVsbCwgJ1NJR1FVSVQnKSk7XG4gICAgcHJvY2Vzcy5vbignU0lHVEVSTScsICgpID0+IGZpbmFsSGFuZGxlcihudWxsLCAnU0lHVEVSTScpKTtcbiAgfVxufVxuIl19